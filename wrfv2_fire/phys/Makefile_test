#FC = ifort -fast -free

FC = ifort -g -debug all -traceback -ftrapuv -inline-debug-info -check all -stand f95 -free 
#FC = g95 -ftrace=frame -g -ffree-form

.SUFFIXES:
.SUFFIXES: .F .o

.F.o: 
	$(FC) -c $*.F

# default speed test function
SPEED = normal_spread

# module dependencies

$(SPEED).o: \
     module_fr_sfire_util.o 

module_fr_cawfe_fuel.o: \
     ../share/module_model_constants.o

module_fr_sfire_model.o: \
     $(SPEED).o \
     module_fr_sfire_core.o  \
     module_fr_cawfe_fuel.o \
     module_fr_sfire_util.o 

module_fr_sfire_core.o: \
     module_fr_sfire_prop.o \
     module_fr_sfire_burn.o \
     module_fr_sfire_util.o 
      
module_fr_sfire_burn.o: \
     module_fr_sfire_util.o 

module_fr_sfire_prop.o: \
     $(SPEED).o \
     module_fr_sfire_util.o 
      
module_fr_sfire_level.o: \
     $(SPEED).o \
     module_fr_sfire_util.o 
      
module_fr_sfire_util.o: \
     wrf_fakes.o

# test binaries and targers

# the propagation alone 
PROP_OBJ = \
     prop_test.F \
     $(SPEED).o \
     module_fr_sfire_prop.o \
     module_fr_sfire_util.o \
     wrf_fakes.o 

prop_test.exe: $(PROP_OBJ)  
	$(FC) -o prop_test.exe $(PROP_OBJ)

prop_test: prop_test.exe
	# run prop_test from matlab to test

# burn balance
FUEL_TEST_OBJ=\
    module_fr_sfire_burn.o \
    module_fr_sfire_util.o \
    wrf_fakes.o \
    burn_test.F

burn_test.exe: $(FUEL_TEST_OBJ)
	$(FC) -o burn_test.exe $(FUEL_TEST_OBJ)

burn_test: burn_test.exe
	./burn_test.exe

# utilities
UTIL_OBJ= \
    util_test.F   \
    module_fr_sfire_util.o  \
    wrf_fakes.o

util_test.exe: $(UTIL_OBJ)
	$(FC) -o util_test.exe $(UTIL_OBJ)

util_test: util_test.exe
	./util_test.exe

# widfire model code

# all object files with the core model
CORE_OBJ= \
    core_test.F \
    $(SPEED).o \
    module_fr_sfire_burn.o \
    module_fr_sfire_util.o  \
    module_fr_sfire_prop.o \
    module_fr_sfire_core.o \
    wrf_fakes.o
    
core_test.exe: $(CORE_OBJ) 
	$(FC) -o core_test.exe $(CORE_OBJ)

core_test: core_test.exe
	# run core_test in Matlab

# core model with improved level set
LEVEL_OBJ= \
    core_test.F \
    $(SPEED).o \
    module_fr_sfire_burn.o \
    module_fr_sfire_util.o  \
    module_fr_sfire_level.o \
    module_fr_sfire_core.o \
    wrf_fakes.o
    
level_test.exe: $(LEVEL_OBJ) 
	$(FC) -o level_test.exe $(LEVEL_OBJ)

level_test: level_test.exe
	# run level_test in Matlab

# the whole model
MODEL_OBJ = \
    model_test.F \
    module_fr_sfire_model.o \
    ../share/module_model_constants.o \
    module_fr_cawfe_fuel.o \
    module_fr_sfire_core.o \
    module_fr_sfire_prop.o \
    module_fr_sfire_burn.o \
    module_fr_sfire_util.o  \
    wrf_fakes.o

model_test:
	make -f Makefile_test model_test.exe SPEED=module_fr_sfire_speed

model_test.exe: $(MODEL_OBJ) 
	$(FC) -o model_test.exe $(MODEL_OBJ)

clean:
	-rm -f *.{exe,o,mod}

